<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shop Assistant â€” Agent Debug View</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      height: 100vh;
      overflow: hidden;
    }
    .header {
      background: #1e293b;
      padding: 1rem 2rem;
      border-bottom: 1px solid #334155;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    .session-input {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .session-input input {
      background: #334155;
      border: 1px solid #475569;
      color: #f1f5f9;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      width: 300px;
    }
    .session-input input:focus {
      outline: none;
      border-color: #14b8a6;
    }
    .session-input button {
      background: #14b8a6;
      color: white;
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: 0.375rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .session-input button:hover {
      background: #0d9488;
    }
    .session-input button:disabled {
      background: #475569;
      cursor: not-allowed;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      height: calc(100vh - 80px);
      gap: 1px;
      background: #334155;
    }
    .window {
      background: #1e293b;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .window-header {
      background: #0f172a;
      padding: 1rem;
      border-bottom: 1px solid #334155;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .window-header .badge {
      background: #14b8a6;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .window-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    .message {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      background: #334155;
      border-radius: 0.5rem;
      border-left: 3px solid #14b8a6;
    }
    .message.user {
      border-left-color: #f59e0b;
    }
    .message.assistant {
      border-left-color: #14b8a6;
    }
    .message-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.75rem;
      color: #94a3b8;
    }
    .message-role {
      font-weight: 600;
      text-transform: uppercase;
    }
    .message-time {
      color: #64748b;
    }
    .message-content {
      color: #f1f5f9;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .agent-message {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      background: #334155;
      border-radius: 0.5rem;
      border-left: 3px solid #8b5cf6;
    }
    .agent-message.request {
      border-left-color: #f59e0b;
    }
    .agent-message.response {
      border-left-color: #10b981;
    }
    .agent-message.task {
      border-left-color: #3b82f6;
    }
    .agent-message.error {
      border-left-color: #ef4444;
    }
    .agent-message-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.75rem;
    }
    .agent-flow {
      color: #94a3b8;
      font-weight: 500;
    }
    .agent-flow .from {
      color: #f59e0b;
    }
    .agent-flow .to {
      color: #10b981;
    }
    .agent-flow .arrow {
      margin: 0 0.5rem;
      color: #64748b;
    }
    .message-type {
      background: #475569;
      color: white;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.7rem;
      text-transform: uppercase;
    }
    .message-type.request {
      background: #f59e0b;
    }
    .message-type.response {
      background: #10b981;
    }
    .message-type.task {
      background: #3b82f6;
    }
    .message-type.error {
      background: #ef4444;
    }
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      opacity: 0.5;
    }
    .loading {
      text-align: center;
      padding: 2rem;
      color: #94a3b8;
    }
    .metadata {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid #475569;
      font-size: 0.7rem;
      color: #94a3b8;
    }
    .metadata pre {
      background: #0f172a;
      padding: 0.5rem;
      border-radius: 0.25rem;
      overflow-x: auto;
      font-size: 0.7rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸ¤– Agent Debug View</h1>
    <div class="session-input">
      <input type="text" id="sessionId" placeholder="Enter session ID" />
      <button id="loadBtn" onclick="loadSession()">Load Session</button>
    </div>
  </div>
  <div class="container">
    <div class="window">
      <div class="window-header">
        <span>Client Communication</span>
        <span class="badge" id="clientCount">0</span>
      </div>
      <div class="window-content" id="clientMessages">
        <div class="empty-state">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <p>Enter a session ID to view client communication</p>
        </div>
      </div>
    </div>
    <div class="window">
      <div class="window-header">
        <span>Agent-to-Agent Communication</span>
        <span class="badge" id="agentCount">0</span>
      </div>
      <div class="window-content" id="agentMessages">
        <div class="empty-state">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
          </svg>
          <p>Enter a session ID to view agent communication</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin + '/api';

    async function loadSession() {
      const sessionId = document.getElementById('sessionId').value.trim();
      if (!sessionId) {
        // Try to get from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const sessionIdParam = urlParams.get('sessionId');
        if (sessionIdParam) {
          document.getElementById('sessionId').value = sessionIdParam;
          return loadSession();
        }
        alert('Please enter a session ID');
        return;
      }

      const loadBtn = document.getElementById('loadBtn');
      loadBtn.disabled = true;
      loadBtn.textContent = 'Loading...';

      try {
        await Promise.all([
          loadClientMessages(sessionId),
          loadAgentCommunications(sessionId)
        ]);
      } catch (error) {
        console.error('Error loading session:', error);
        alert('Failed to load session: ' + error.message);
      } finally {
        loadBtn.disabled = false;
        loadBtn.textContent = 'Load Session';
      }
    }

    async function loadClientMessages(sessionId) {
      const container = document.getElementById('clientMessages');
      container.innerHTML = '<div class="loading">Loading client messages...</div>';

      try {
        const response = await fetch(`${API_BASE}/sessions/${sessionId}/messages`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();

        if (data.messages && data.messages.length > 0) {
          container.innerHTML = data.messages.map(msg => `
            <div class="message ${msg.role}">
              <div class="message-header">
                <span class="message-role">${msg.role}</span>
                <span class="message-time">${formatTime(msg.createdAt)}</span>
              </div>
              <div class="message-content">${escapeHtml(msg.content)}</div>
            </div>
          `).join('');
          document.getElementById('clientCount').textContent = data.messages.length;
        } else {
          container.innerHTML = '<div class="empty-state"><p>No client messages found</p></div>';
          document.getElementById('clientCount').textContent = '0';
        }
      } catch (error) {
        container.innerHTML = `<div class="empty-state"><p>Error: ${escapeHtml(error.message)}</p></div>`;
        document.getElementById('clientCount').textContent = '0';
      }
    }

    async function loadAgentCommunications(sessionId) {
      const container = document.getElementById('agentMessages');
      container.innerHTML = '<div class="loading">Loading agent communications...</div>';

      try {
        const response = await fetch(`${API_BASE}/sessions/${sessionId}/agent-communications`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();

        if (data.communications && data.communications.length > 0) {
          container.innerHTML = data.communications.map(comm => `
            <div class="agent-message ${comm.messageType}">
              <div class="agent-message-header">
                <div class="agent-flow">
                  <span class="from">${escapeHtml(comm.fromAgent)}</span>
                  <span class="arrow">â†’</span>
                  <span class="to">${escapeHtml(comm.toAgent)}</span>
                </div>
                <div>
                  <span class="message-type ${comm.messageType}">${comm.messageType}</span>
                  <span class="message-time" style="margin-left: 0.5rem;">${formatTime(comm.createdAt)}</span>
                </div>
              </div>
              <div class="message-content">${escapeHtml(comm.content)}</div>
              ${comm.metadata ? `
                <div class="metadata">
                  <pre>${JSON.stringify(comm.metadata, null, 2)}</pre>
                </div>
              ` : ''}
            </div>
          `).join('');
          document.getElementById('agentCount').textContent = data.communications.length;
        } else {
          container.innerHTML = '<div class="empty-state"><p>No agent communications found</p></div>';
          document.getElementById('agentCount').textContent = '0';
        }
      } catch (error) {
        container.innerHTML = `<div class="empty-state"><p>Error: ${escapeHtml(error.message)}</p></div>`;
        document.getElementById('agentCount').textContent = '0';
      }
    }

    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleTimeString() + ' ' + date.toLocaleDateString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Allow Enter key to trigger load
    document.getElementById('sessionId').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        loadSession();
      }
    });

    // Auto-refresh every 5 seconds if session is loaded
    let refreshInterval = null;
    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(() => {
        const sessionId = document.getElementById('sessionId').value.trim();
        if (sessionId) {
          loadClientMessages(sessionId);
          loadAgentCommunications(sessionId);
        }
      }, 5000);
    }

    document.getElementById('sessionId').addEventListener('input', () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    });

    // Start auto-refresh after first load
    const originalLoadSession = loadSession;
    loadSession = async function() {
      await originalLoadSession();
      startAutoRefresh();
    };

    // Auto-load if sessionId is in URL params
    const urlParams = new URLSearchParams(window.location.search);
    const sessionIdParam = urlParams.get('sessionId');
    if (sessionIdParam) {
      document.getElementById('sessionId').value = sessionIdParam;
      loadSession();
    }
  </script>
</body>
</html>
